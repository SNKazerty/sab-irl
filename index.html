<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Steal a Brainrot IRL</title>
<style>
  body { font-family: system-ui, Arial; background: #0b0b0b; color: #f4f4f4; margin:0; padding:18px }
  .wrap { max-width:920px; margin:0 auto }
  header { display:flex; align-items:center; gap:12px; margin-bottom:12px }
  h1 { font-size:20px; margin:0 }
  .card { background:linear-gradient(180deg,#111,#0b0b0b); border-radius:12px; padding:12px; margin:10px 0; border:1px solid rgba(255,255,255,0.04) }
  .row { display:flex; justify-content:space-between; align-items:center }
  .big { font-size:1.1rem; font-weight:800 }
  .small { font-size:0.85rem; color:#bdbdbd }
  .imgbox { width:120px; height:120px; border-radius:10px; background:#151515; display:flex; align-items:center; justify-content:center; overflow:hidden }
  button { padding:8px 12px; border-radius:8px; border:0; background:#ff6b6b; color:white; cursor:pointer; font-weight:700 }
  #catalogModal { max-height:70vh; overflow-y:auto }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Steal a Brainrot IRL</h1>
    <div class="small">Scan, ajoute, collectionne.</div>
  </header>

  <div class="card" id="scanInfo"></div>

  <div class="card">
    <div class="row">
      <div>
        <div class="small">Ton inventaire (stocké localement)</div>
        <div id="totalPerSec" class="big">Total: 0 /s</div>
      </div>
      <div><button id="openCatalog">Voir le catalogue</button></div>
    </div>
    <div id="collection" style="margin-top:10px"></div>
  </div>

  <div id="catalogModal" style="display:none" class="card"></div>
</div>

<script type="module">
// --- CONFIG SUPABASE ---
const SUPABASE_URL = 'https://yghzfxnbxnxmwoqxajdw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnaHpmeG5ieG54bXdvcXhhamR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NDYzOTQsImV4cCI6MjA3NzUyMjM5NH0.DizNOQOx2ZqgDyVwOuxV1LS0skImeV5irdGaerCiUg4';

// On utilise un import dynamique fiable (jsDelivr)
import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.31.0/dist/supabase.min.js')
.then(({ createClient }) => {
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- utilitaires ---
  function nstr(n){ return isNaN(n) ? n : Number(n).toLocaleString('en-US'); }
  function saveLocal(items){ localStorage.setItem('brainrot_collection', JSON.stringify(items)); }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem('brainrot_collection')||'[]'); }catch(e){ return []; } }

  // --- rendu collection ---
  function renderCollection(){
    const items = loadLocal();
    const cont = document.getElementById('collection');
    cont.innerHTML = '';
    let total = 0;
    if(items.length === 0){
      cont.innerHTML = '<div class="small">Aucun brainrot ajouté — scanne un QR.</div>';
    } else {
      items.forEach(it=>{
        total += Number(it.gain_per_second || 0);
        const node = document.createElement('div');
        node.className = 'row';
        node.style.marginTop = '8px';

        const inner = document.createElement('div');
        inner.style.display='flex';
        inner.style.gap='10px';
        inner.style.alignItems='center';
        inner.innerHTML = `
          <div class="imgbox">
            <img src="${it.display_image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
          </div>
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="small">${nstr(it.gain_per_second)} /s • ${it.rarity||''}</div>
          </div>
        `;
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Retirer';
        removeBtn.addEventListener('click', ()=> removeItem(it.id));
        node.appendChild(inner);
        node.appendChild(removeBtn);
        cont.appendChild(node);
      });
    }
    document.getElementById('totalPerSec').innerText = `Total: ${nstr(total)} /s`;
  }

  function removeItem(id){
    let items = loadLocal();
    items = items.filter(it => it.id !== id);
    saveLocal(items);
    renderCollection();
  }

  function addItem(obj){
    let items = loadLocal();
    if(items.find(it => it.id === obj.id)){ alert('Déjà dans ta collection.'); return; }
    items.push(obj);
    saveLocal(items);
    renderCollection();
  }

  // --- catalogue fetch ---
  async function fetchCatalog(){
    const { data, error } = await supabase.from('Brainrots').select('*').order('name', { ascending:true });
    if(error){ console.error('Supabase error:', error); return []; }
    return data || [];
  }

  document.getElementById('openCatalog').addEventListener('click', async ()=>{
    const list = await fetchCatalog();
    const modal = document.getElementById('catalogModal');
    modal.style.display = 'block';
    modal.innerHTML = '<div style="font-weight:800;margin-bottom:8px">Catalogue</div>';

    if(list.length === 0){
      modal.innerHTML += '<div class="small">Catalogue vide.</div>';
    } else {
      list.forEach(it=>{
        const d = document.createElement('div');
        d.className='card';
        const row = document.createElement('div');
        row.className='row';
        row.style.display='flex';
        row.style.gap='10px';
        row.style.alignItems='center';

        const imgBox = document.createElement('div'); imgBox.className='imgbox';
        const img = document.createElement('img');
        img.src = it.display_image || '';
        img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
        img.onerror = ()=> img.style.display='none';
        imgBox.appendChild(img);

        const info = document.createElement('div');
        info.innerHTML = `
          <div style="font-weight:800">${it.name}</div>
          <div class="small">${nstr(it.gain_per_second)} /s • ${it.rarity||''}</div>
          <div class="small">Prix: ${it.price||'-'}</div>
        `;
        const addBtn = document.createElement('button');
        addBtn.textContent='Ajouter';
        addBtn.addEventListener('click', ()=> addItem(it));

        row.appendChild(imgBox); row.appendChild(info); row.appendChild(addBtn);
        d.appendChild(row);
        modal.appendChild(d);
      });
    }

    const close = document.createElement('div');
    close.style.marginTop='6px';
    const closeBtn = document.createElement('button');
    closeBtn.textContent='Fermer';
    closeBtn.addEventListener('click', ()=> modal.style.display='none');
    close.appendChild(closeBtn);
    modal.appendChild(close);
  });

  // --- onLoad: scan ID from URL ---
  (async function onLoad(){
    renderCollection();
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(!id) return;

    const info = document.getElementById('scanInfo');
    info.innerHTML = '<div class="small">Recherche du brainrot…</div>';

    try {
      const { data, error } = await supabase.from('Brainrots').select('*').eq('id', id).single();
      if(error){
        console.error('Supabase error:', error);
        info.innerHTML = '<div class="small">Brainrot inconnu</div>';
        return;
      }
      if(!data){
        info.innerHTML = '<div class="small">Brainrot introuvable</div>';
        return;
      }

      const it = data;
      info.innerHTML = `
        <div class="row" style="display:flex;gap:12px;align-items:center">
          <div class="imgbox">
            <img src="${it.display_image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">
          </div>
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="small">${nstr(it.gain_per_second)} /s • ${it.rarity||''}</div>
            <div class="small">Prix: ${it.price||'-'}</div>
          </div>
        </div>
      `;
      const addBtn = document.createElement('button');
      addBtn.textContent='Ajouter';
      addBtn.addEventListener('click', ()=> addItem(it));
      info.appendChild(addBtn);

    } catch(e){
      console.error('Erreur JS:', e);
      info.innerHTML = '<div class="small">Erreur lors de la requête</div>';
    }
  })();

}) // fin then createClient
.catch(err => {
  // si le module ne peut pas être chargé
  console.error('Erreur lors du chargement du module Supabase :', err);
  const info = document.getElementById('scanInfo');
  if(info) info.innerHTML = '<div class="small">Impossible de charger Supabase (vérifie le CDN)</div>';
});
</script>
</body>
</html>
