<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Steal a Brainrot IRL</title>
<style>
  body{font-family:system-ui,Arial;background:#0b0b0b;color:#f4f4f4;margin:0;padding:18px}
  .wrap{max-width:920px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .card{background:linear-gradient(180deg,#111,#0b0b0b);border-radius:12px;padding:12px;margin:10px 0;border:1px solid rgba(255,255,255,0.04)}
  .row{display:flex;justify-content:space-between;align-items:center}
  .big{font-size:1.1rem;font-weight:800}
  .small{font-size:0.85rem;color:#bdbdbd}
  .imgbox{width:120px;height:120px;border-radius:10px;background:#151515;display:flex;align-items:center;justify-content:center;overflow:hidden}
  button{padding:8px 12px;border-radius:8px;border:0;background:#ff6b6b;color:white;cursor:pointer;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Steal a Brainrot IRL</h1><div class="small">Scan, ajoute, collectionne.</div></header>

  <div class="card" id="scanInfo"></div>

  <div class="card">
    <div class="row">
      <div>
        <div class="small">Ton inventaire (stocké localement)</div>
        <div id="totalPerSec" class="big">Total: 0 /s</div>
      </div>
      <div><button id="openCatalog">Voir le catalogue</button></div>
    </div>
    <div id="collection" style="margin-top:10px"></div>
  </div>

  <div id="catalogModal" style="display:none" class="card"></div>
</div>

<script type="module">
// Remplace ces variables d'environnement avec celles de Supabase (config via Vercel ou remplace ici pour test local)
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL || 'REPLACE_WITH_SUPABASE_URL';
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY || 'REPLACE_WITH_ANON_KEY';

// If you want to test locally without Vercel, replace the strings above with your Supabase values.

import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/module/supabase.js').then(({createClient})=>{
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function nstr(n){ if(isNaN(n)) return n; return Number(n).toLocaleString('en-US'); }
  function saveLocal(items){ localStorage.setItem('brainrot_collection', JSON.stringify(items)); }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem('brainrot_collection')||'[]'); }catch(e){return [];} }

  async function fetchCatalog(){
    const { data, error } = await supabase.from('brainrots').select('*').order('name', {ascending: true});
    if(error){ console.error(error); return []; }
    return data || [];
  }

  function renderCollection(){
    const items = loadLocal();
    const cont = document.getElementById('collection');
    cont.innerHTML = '';
    let total = 0;
    if(items.length===0) cont.innerHTML = '<div class="small">Aucun brainrot ajouté — scanne un QR.</div>';
    items.forEach(it=>{
      total += Number(it.gain_per_second||0);
      const node = document.createElement('div');
      node.className='row';
      node.style.marginTop='8px';
      node.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
          <div class="imgbox"><img src="${it.display_image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="small">${nstr(it.gain_per_second)} /s • ${it.rarity||''}</div>
          </div>
        </div>
        <div><button onclick="removeItem('${it.id}')">Retirer</button></div>`;
      cont.appendChild(node);
    });
    document.getElementById('totalPerSec').innerText = `Total: ${nstr(total)} /s`;
  }

  function removeItem(id){
    let items = loadLocal();
    items = items.filter(it=>it.id!==id);
    saveLocal(items);
    renderCollection();
  }

  function addItem(obj){
    let items = loadLocal();
    if(items.find(it=>it.id===obj.id)){ alert('Déjà dans ta collection.'); return; }
    items.push(obj);
    saveLocal(items);
    renderCollection();
  }

  document.getElementById('openCatalog').addEventListener('click', async ()=>{
    const list = await fetchCatalog();
    const modal = document.getElementById('catalogModal');
    modal.style.display='block';
    modal.innerHTML = '<div style="font-weight:800;margin-bottom:8px">Catalogue</div>';
    list.forEach(it=>{
      const d = document.createElement('div');
      d.className='card';
      d.innerHTML = `<div class="row">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="imgbox"><img src="${it.display_image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="small">${nstr(it.gain_per_second)} /s • ${it.rarity}</div>
            <div class="small">Prix: ${it.price||'-'}</div>
          </div>
        </div>
        <div><button onclick='addItem(${JSON.stringify(it)})'>Ajouter</button></div>
      </div>`;
      modal.appendChild(d);
    });
    const close = document.createElement('div');
    close.style.marginTop='6px';
    close.innerHTML = `<button onclick="document.getElementById('catalogModal').style.display='none'">Fermer</button>`;
    modal.appendChild(close);
  });

  // If we have ?id=... (scan QR), show info and propose to add
  (async function onLoad(){
    renderCollection();
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if(id){
      const info = document.getElementById('scanInfo');
      info.innerHTML = '<div class="small">Recherche du brainrot…</div>';
      const { data, error } = await supabase.from('brainrots').select('*').eq('id', id).limit(1).single();
      if(error || !data){ info.innerHTML = '<div class="small">Brainrot inconnu</div>'; return; }
      const it = data;
      info.innerHTML = `<div class="row">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="imgbox"><img src="${it.display_image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
          <div>
            <div style="font-weight:800">${it.name}</div>
            <div class="small">${nstr(it.gain_per_second)} /s • ${it.rarity}</div>
            <div class="small">Prix: ${it.price||'-'}</div>
          </div>
        </div>
        <div>
          <button id="addBtn">Ajouter</button>
        </div>
      </div>`;
      document.getElementById('addBtn').addEventListener('click', ()=>{ addItem(it); });
    }
  })();

});
</script>
</body>
</html>
